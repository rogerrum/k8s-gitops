---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: generate-oidc-security-policy
spec:
  rules:
    - name: clone-oidc-secret-to-namespace
      match:
        any:
          - resources:
              kinds:
                - HTTPRoute
              selector:
                matchLabels:
                  security: authenticated
      context:
        - name: clientID
          apiCall:
            urlPath: "/api/v1/namespaces/kube-system/secrets/oidc-secret"
            jmesPath: "data.\"client-id\""
        - name: clientSecret
          apiCall:
            urlPath: "/api/v1/namespaces/kube-system/secrets/oidc-secret"
            jmesPath: "data.\"client-secret\""
      generate:
        generateExisting: true
        apiVersion: v1
        kind: Secret
        name: "oidc-secret"
        namespace: "{{ `{{ request.object.metadata.namespace }}` }}"
        synchronize: true
        data:
          type: Opaque
          data:
            client-id: "{{ `{{ clientID }}` }}"
            client-secret: "{{ `{{ clientSecret }}` }}"
    - name: generate-security-policy-for-httproute
      match:
        any:
          - resources:
              kinds:
                - HTTPRoute
              selector:
                matchLabels:
                  security: authenticated
      context:
        - name: clientID
          apiCall:
            urlPath: "/api/v1/namespaces/kube-system/secrets/oidc-secret"
            jmesPath: "data.\"client-id\" | base64_decode(@)"
      generate:
        generateExisting: true
        apiVersion: gateway.envoyproxy.io/v1alpha1
        kind: SecurityPolicy
        name: "{{ `{{ request.object.metadata.name }}` }}-auth"
        namespace: "{{ `{{ request.object.metadata.namespace }}` }}"
        synchronize: true
        data:
          spec:
            targetRefs:
              - group: gateway.networking.k8s.io
                kind: HTTPRoute
                name: "{{ `{{ request.object.metadata.name }}` }}"
            oidc:
              provider:
                issuer: "https://pi.rsr.net"
                authorizationEndpoint: "https://pi.rsr.net/authorize"
                tokenEndpoint: "https://pi.rsr.net/api/oidc/token"
              clientID: "{{ `{{ clientID }}` }}"
              clientSecret:
                name: "oidc-secret"
              redirectURL: "https://{{ `{{ request.object.spec.hostnames[0] }}` }}/oauth2/callback"
              logoutPath: "/logout"
              scopes:
                - openid
                - email
                - profile
                - groups
              cookieDomain: "rsr.net"
