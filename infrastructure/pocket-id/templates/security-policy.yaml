# SecurityPolicy for OAuth2-Proxy authentication
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: {{ .Release.Name }}-auth
  namespace: default
  labels:
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/part-of: {{ .Release.Name }}
spec:
  # Use label selector to match HTTPRoutes
  targetSelectors:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      matchLabels:
        security: "authenticated1"  # Any HTTPRoute with this label will be protected
          # Add namespace selector to match routes in any namespace
  oidc:
    provider:
      issuer: "https://pi.rsr.net"
      # Browser-facing endpoint - must be HTTPS external URL
      authorizationEndpoint: "https://pi.rsr.net/authorize"
      # Internal cluster endpoint - use HTTP to avoid TLS cert verification issues
      tokenEndpoint: "http://pocket-id.kube-system.svc.cluster.local:1411/api/oidc/token"
    clientIDRef:
      name: "oidc-secret"
      namespace: "kube-system"
    clientSecret:
      name: "oidc-secret"
      namespace: "kube-system"
    # This redirectURL is used as a template
    # Each app's actual callback is at <app-hostname>/oauth2/callback
    redirectURL: "https://tools.rsr.net/oauth2/callback"
    logoutPath: "/logout"
    scopes:
      - openid
      - email
      - profile
      - groups
    cookieDomain: "rsr.net"
