---
# MutatingAdmissionPolicyBinding for volsync-mover-jitter
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: volsync-mover-jitter
  labels:
    app.kubernetes.io/name: volsync
    app.kubernetes.io/component: admission
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  policyName: volsync-mover-jitter
---
# MutatingAdmissionPolicy for volsync-mover-jitter
# Adds 0-30s random delay to backup jobs to prevent thundering herd
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicy
metadata:
  name: volsync-mover-jitter
  labels:
    app.kubernetes.io/name: volsync
    app.kubernetes.io/component: admission
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  matchConstraints:
    resourceRules:
      - apiGroups:
          - "batch"
        apiVersions:
          - "v1"
        operations:
          - "CREATE"
          - "UPDATE"
        resources:
          - "jobs"
  matchConditions:
    - name: has-volsync-job-name-prefix
      expression: >-
        object.metadata.name.startsWith("volsync-src-")
    - name: has-volsync-created-by-labels
      expression: >-
        object.metadata.?labels["app.kubernetes.io/created-by"].orValue("") == "volsync"
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: "JSONPatch"
      jsonPatch:
        expression: >
          [
            JSONPatch{
              op: "add", path: "/spec/template/spec/initContainers",
              value: []
            },
            JSONPatch{
              op: "add", path: "/spec/template/spec/initContainers/-",
              value: Object.spec.template.spec.initContainers{
                name: "jitter",
                image: "docker.io/library/busybox:latest",
                imagePullPolicy: "IfNotPresent",
                command: ["sh", "-c", "sleep $(shuf -i 0-30 -n 1)"]
              }
            }
          ]
---
# MutatingAdmissionPolicyBinding for volsync-mover-nfs
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: volsync-mover-nfs
  labels:
    app.kubernetes.io/name: volsync
    app.kubernetes.io/component: admission
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  policyName: volsync-mover-nfs
---
# MutatingAdmissionPolicy for volsync-mover-nfs
# Auto-injects NFS mount into VolSync jobs for Kopia repository access
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingAdmissionPolicy
metadata:
  name: volsync-mover-nfs
  labels:
    app.kubernetes.io/name: volsync
    app.kubernetes.io/component: admission
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  matchConstraints:
    resourceRules:
      - apiGroups:
          - "batch"
        apiVersions:
          - "v1"
        operations:
          - "CREATE"
          - "UPDATE"
        resources:
          - "jobs"
  matchConditions:
    - name: has-volsync-job-name-prefix
      expression: >-
        object.metadata.name.startsWith("volsync-")
    - name: has-volsync-created-by-labels
      expression: >-
        object.metadata.?labels["app.kubernetes.io/created-by"].orValue("") == "volsync"
    - name: repository-volume-does-not-exist
      expression: >-
        !has(object.spec.template.spec.volumes) ||
        !object.spec.template.spec.volumes.exists(item, item.name == "repository")
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: "JSONPatch"
      jsonPatch:
        expression: >-
          [
            JSONPatch{
              op: "add", path: "/spec/template/spec/volumes/-",
              value: Object.spec.template.spec.volumes{
                name: "repository",
                nfs: Object.spec.template.spec.volumes.nfs{
                  server: "192.168.1.115",
                  path: "/Kopia"
                }
              }
            },
            JSONPatch{
              op: "add", path: "/spec/template/spec/containers/0/volumeMounts/-",
              value: Object.spec.template.spec.containers.volumeMounts{
                name: "repository",
                mountPath: "/repository"
              }
            }
          ]
