{{- $apps := include "volsync.parseApps" . | fromJsonArray -}}
{{- range $apps }}
{{- /*
  PVC creation logic:
  - If global createPVCs is false: Don't create ReplicationDestination or PVC
  - If global createPVCs is true AND app-level createPVC is not explicitly false: Create both
  - If app-level createPVC is explicitly false: Don't create (override global setting)
*/ -}}
{{- $shouldCreatePVC := false -}}
{{- if $.Values.createPVCs -}}
  {{- if hasKey . "createPVC" -}}
    {{- if ne .createPVC false -}}
      {{- $shouldCreatePVC = true -}}
    {{- end -}}
  {{- else -}}
    {{- $shouldCreatePVC = true -}}
  {{- end -}}
{{- end -}}
{{- if $shouldCreatePVC }}
---
# ReplicationDestination for bootstrap restore for {{ .app }}
# Note: Only created when PVC is being created to avoid premature restore attempts
apiVersion: volsync.backube/v1alpha1
kind: ReplicationDestination
metadata:
  name: {{ .app }}-bootstrap
  namespace: {{ .namespace }}
  labels:
    app.kubernetes.io/name: volsync
    app.kubernetes.io/component: restore
    app.kubernetes.io/instance: {{ $.Release.Name }}
    volsync.backube/app: {{ .app }}
spec:
  trigger:
    manual: restore-once
  kopia:
    repository: {{ .app }}-kopia-secret
    copyMethod: Snapshot
    storageClassName: longhorn
    volumeSnapshotClassName: longhorn-snapshot-vsc
    accessModes: [ReadWriteOnce]
    capacity: {{ .capacity }}
    {{- if .cacheCapacity }}
    cacheCapacity: {{ .cacheCapacity }}
    cacheStorageClassName: longhorn
    cacheAccessModes: [ReadWriteOnce]
    {{- end }}
    moverSecurityContext:
      runAsUser: {{ .runAsUser }}
      runAsGroup: {{ .runAsUser }}
      fsGroup: {{ .runAsUser }}
    moverAffinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: google.feature.node.kubernetes.io/coral
                  operator: In
                  values:
                    - "true"
    sourceIdentity:
      sourceName: {{ .app }}
    cleanupTempPVC: true
    cleanupCachePVC: true
    enableFileDeletion: true
---
# PVC with conditional dataSourceRef for automatic bootstrap for {{ .app }}
# Note: Both annotations prevent deletion - helm.sh for Helm/ArgoCD 2.7+, argocd for older versions
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ .app }}-{{ .pvcSuffix }}
  namespace: {{ .namespace }}
  annotations:
    helm.sh/resource-policy: keep
    argocd.argoproj.io/sync-options: Prune=false
  labels:
    app.kubernetes.io/name: volsync
    app.kubernetes.io/component: restore
    app.kubernetes.io/instance: {{ $.Release.Name }}
    volsync.backube/app: {{ .app }}
spec:
  accessModes:
    - ReadWriteOnce
  dataSourceRef:
    apiGroup: volsync.backube
    kind: ReplicationDestination
    name: {{ .app }}-bootstrap
  storageClassName: longhorn
  resources:
    requests:
      storage: {{ .capacity }}
{{- end }}
{{- end }}
