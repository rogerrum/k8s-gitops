{{- $fullName := include "external-route.fullname" . -}}
{{- $labels := include "external-route.labels" . | nindent 4}}
{{- $tlsProxyApps := list }}
{{- range .Values.apps }}
  {{- if and .tlsProxy .tlsProxy.enabled }}
    {{- $tlsProxyApps = append $tlsProxyApps . }}
  {{- end }}
{{- end }}
{{- if gt (len $tlsProxyApps) 0 }}
---
# ConfigMap for shared NGINX TLS proxy
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $fullName }}-tls-proxy-config
  labels:
    {{- $labels }}
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
      worker_connections 1024;
    }

    http {
      access_log /var/log/nginx/access.log;

      # Map for WebSocket upgrade support (must be defined before use)
      map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
      }

      # Define upstreams for each backend
      {{- range $tlsProxyApps }}
      upstream {{ .name }}_backend {
        server {{ .service.externalName }}:{{ .port }};
      }
      {{- end }}

      {{- range $tlsProxyApps }}
      # Server block for {{ .name }}
      server {
        listen 8080;
        http2 on;
        server_name {{ .host }};

        # Timeouts at server level
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 1800s;

        # Buffer settings
        proxy_buffers 16 32k;
        proxy_buffer_size 64k;
        client_max_body_size 0;

        location / {
          # Proxy to legacy TLS backend
          proxy_pass https://{{ .name }}_backend;

          # SSL settings for very old backends (iDRAC 7, old Proxmox)
          proxy_ssl_verify off;
          proxy_ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
          proxy_ssl_ciphers 'ALL:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:@SECLEVEL=0';
          proxy_ssl_server_name off;
          proxy_ssl_session_reuse off;

          # HTTP settings
          proxy_http_version 1.1;
          proxy_buffering off;

          # Headers
          proxy_set_header Host {{ .service.externalName }};
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto https;
          proxy_set_header X-Forwarded-Host $host;

          # WebSocket support
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
        }
      }
      {{- end }}
    }
---
# Deployment for shared NGINX TLS proxy
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $fullName }}-tls-proxy
  labels:
    {{- $labels }}
    app.kubernetes.io/component: tls-proxy
    app: {{ $fullName }}-tls-proxy
spec:
  replicas: {{ .Values.tlsProxy.replicas | default 2 }}
  selector:
    matchLabels:
      app: {{ $fullName }}-tls-proxy
  template:
    metadata:
      labels:
        app: {{ $fullName }}-tls-proxy
        {{- $labels }}
    spec:
      containers:
      - name: nginx
        image: {{ .Values.tlsProxy.image | default "nginx:1.27-alpine" }}
        imagePullPolicy: IfNotPresent
        ports:
        - name: https
          containerPort: 8080
          protocol: TCP
        volumeMounts:
        - name: config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        livenessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        readinessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 2
          failureThreshold: 2
        resources:
          {{- if .Values.tlsProxy.resources }}
          {{- toYaml .Values.tlsProxy.resources | nindent 10 }}
          {{- else }}
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
          {{- end }}
      volumes:
      - name: config
        configMap:
          name: {{ $fullName }}-tls-proxy-config
---
# Service for shared NGINX TLS proxy
apiVersion: v1
kind: Service
metadata:
  name: {{ $fullName }}-tls-proxy
  labels:
    {{- $labels }}
    app.kubernetes.io/component: tls-proxy
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: https
  selector:
    app: {{ $fullName }}-tls-proxy
{{- end }}

