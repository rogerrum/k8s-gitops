{{- $fullName := include "external-route.fullname" . -}}
{{- $labels := include "external-route.labels" . | nindent 4}}
{{- $tlsProxyApps := list }}
{{- range .Values.apps }}
  {{- if and .tlsProxy .tlsProxy.enabled }}
    {{- $tlsProxyApps = append $tlsProxyApps . }}
  {{- end }}
{{- end }}
{{- if gt (len $tlsProxyApps) 0 }}
---
# ConfigMap for shared NGINX TLS proxy
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $fullName }}-tls-proxy-config
  labels:
    {{- $labels }}
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
      worker_connections 1024;
    }

    http {
      access_log /var/log/nginx/access.log;

      # Define upstreams for each backend
      {{- range $tlsProxyApps }}
      upstream {{ .name }}_backend {
        server {{ .service.externalName }}:{{ .port }};
      }
      {{- end }}

      {{- range $tlsProxyApps }}
      # Server block for {{ .name }}
      server {
        listen 8080 ssl http2;
        server_name {{ .host }};

        # TLS configuration using {{ .name }}'s certificate
        ssl_certificate /etc/nginx/certs-{{ .name }}/tls.crt;
        ssl_certificate_key /etc/nginx/certs-{{ .name }}/tls.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Proxy settings for legacy TLS backend
        proxy_ssl_verify off;
        proxy_ssl_protocols TLSv1 TLSv1.2;
        proxy_ssl_ciphers DEFAULT:@SECLEVEL=0;

        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 1800s;

        # Large buffer sizes for consoles
        proxy_buffers 16 32k;
        proxy_buffer_size 64k;
        client_max_body_size 0;

        location / {
          proxy_pass https://{{ .name }}_backend;
        }
      }
      {{- end }}
    }

    map $http_upgrade $connection_upgrade {
      default upgrade;
      '' close;
    }
---
# Deployment for shared NGINX TLS proxy
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ $fullName }}-tls-proxy
  labels:
    {{- $labels }}
    app.kubernetes.io/component: tls-proxy
    app: {{ $fullName }}-tls-proxy
spec:
  replicas: {{ .Values.tlsProxy.replicas | default 2 }}
  selector:
    matchLabels:
      app: {{ $fullName }}-tls-proxy
  template:
    metadata:
      labels:
        app: {{ $fullName }}-tls-proxy
        {{- $labels }}
    spec:
      containers:
      - name: nginx
        image: {{ .Values.tlsProxy.image | default "nginx:1.27-alpine" }}
        imagePullPolicy: IfNotPresent
        ports:
        - name: https
          containerPort: 8080
          protocol: TCP
        volumeMounts:
        - name: config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        {{- range $tlsProxyApps }}
        - name: certs-{{ .name }}
          mountPath: /etc/nginx/certs-{{ .name }}
          readOnly: true
        {{- end }}
        livenessProbe:
          httpGet:
            path: /
            port: 8080
            scheme: HTTPS
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /
            port: 8080
            scheme: HTTPS
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 2
        resources:
          {{- if .Values.tlsProxy.resources }}
          {{- toYaml .Values.tlsProxy.resources | nindent 10 }}
          {{- else }}
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
          {{- end }}
      volumes:
      - name: config
        configMap:
          name: {{ $fullName }}-tls-proxy-config
      {{- range $tlsProxyApps }}
      - name: certs-{{ .name }}
        secret:
          secretName: {{ .certificate.secretName | default (printf "%s-%s-cert-secret" $fullName .name) }}
      {{- end }}
---
# Service for shared NGINX TLS proxy
apiVersion: v1
kind: Service
metadata:
  name: {{ $fullName }}-tls-proxy
  labels:
    {{- $labels }}
    app.kubernetes.io/component: tls-proxy
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: https
  selector:
    app: {{ $fullName }}-tls-proxy
{{- end }}

